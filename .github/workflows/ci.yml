name: MLflow CI - retrain & build docker

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"

jobs:
  retrain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r MLProject/requirements.txt
          pip install "mlflow[extras]"

      - name: Run MLflow Project (local env)
        run: |
          cd MLProject
          mlflow run . -P n_estimators=100 -P random_state=42 --env-manager local

      - name: Show created files
        run: |
          cd MLProject
          echo "Run files:"
          ls -la
          ls -la mlruns || true
          if [ -f run_id.txt ]; then echo "run_id:" $(cat run_id.txt); fi

      - name: Upload mlruns and model artifacts to GitHub Actions artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlruns-and-model
          path: |
            MLProject/mlruns
            MLProject/run_id.txt
            MLProject/run_summary.json

  build-and-push-docker:
    needs: retrain
    runs-on: ubuntu-latest
    # Only run this job when the DockerHub secrets are present (non-empty)
    if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_PASSWORD != '' && secrets.DOCKERHUB_REPO != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Basic checks for secrets (fail with clear message if missing)
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ] || [ -z "${{ secrets.DOCKERHUB_PASSWORD }}" ] || [ -z "${{ secrets.DOCKERHUB_REPO }}" ]; then
            echo "ERROR: Docker Hub secrets not set. Set DOCKERHUB_USERNAME, DOCKERHUB_PASSWORD, DOCKERHUB_REPO in repo secrets."
            exit 1
          fi
          echo "Docker Hub secrets appear set."

      - name: Install Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Python (for mlflow CLI)
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install mlflow
        run: |
          python -m pip install --upgrade pip
          pip install "mlflow[extras]"

      - name: Get run_id from repo (generated by retrain job)
        run: |
          if [ -f MLProject/run_id.txt ]; then
            RUN_ID=$(cat MLProject/run_id.txt)
            echo "Found run id: $RUN_ID"
            echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          else
            echo "ERROR: MLProject/run_id.txt not found. Ensure retrain step produced it."
            exit 1
          fi

      - name: Log in to Docker Hub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
        run: |
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - name: Build Docker image using mlflow models build-docker
        env:
          RUN_ID: ${{ env.RUN_ID }}
          DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_REPO }}
        run: |
          echo "Building docker image from runs:/$RUN_ID/model"
          mlflow models build-docker --model-uri "runs:/$RUN_ID/model" --name "$DOCKER_IMAGE_NAME"

      - name: Push Docker image
        run: |
          docker push "${{ secrets.DOCKERHUB_REPO }}"

      - name: Publish build metadata
        run: |
          echo "Docker image pushed: ${{ secrets.DOCKERHUB_REPO }}"
