name: MLflow CI - retrain & build docker

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_REPO }} # ex: username/repo:tag

jobs:
  retrain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r MLProject/requirements.txt
          pip install mlflow[extras]  # ensure mlflow CLI available

      - name: Run MLflow Project (local env)
        # use --env-manager local to avoid conda creation on runner (we installed deps via pip)
        run: |
          cd MLProject
          mlflow run . -P n_estimators=100 -P random_state=42 --env-manager local

      - name: Show created files
        run: |
          cd MLProject
          echo "Run files:"
          ls -la
          echo "MLruns top level:"
          ls -la mlruns || true
          if [ -f run_id.txt ]; then echo "run_id:" $(cat run_id.txt); fi

      - name: Upload mlruns and model artifacts to GitHub Actions artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlruns-and-model
          path: |
            MLProject/mlruns
            MLProject/run_id.txt
            MLProject/run_summary.json

  build-and-push-docker:
    needs: retrain
    runs-on: ubuntu-latest
    if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_PASSWORD && secrets.DOCKERHUB_REPO }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker CLI
        uses: docker/setup-buildx-action@v3

      - name: Set up Python (for mlflow CLI)
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install mlflow
        run: |
          python -m pip install --upgrade pip
          pip install mlflow[extras]

      - name: Get run_id from previous job artifacts
        run: |
          # artifact run_id is in MLProject/run_id.txt (it exists in repo workspace because retrain job uploaded it)
          # Download artifacts produced by previous job
          echo "Listing workspace:"
          ls -la
          # If you used upload-artifact above, Actions keeps them per workflow; but easiest is to read file from repo:
          if [ -f MLProject/run_id.txt ]; then
            RUN_ID=$(cat MLProject/run_id.txt)
            echo "Found run id: $RUN_ID"
            echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          else
            echo "ERROR: MLProject/run_id.txt not found. Aborting."
            exit 1
          fi

      - name: Log in to Docker Hub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
        run: |
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - name: Build Docker image using mlflow models build-docker
        env:
          RUN_ID: ${{ env.RUN_ID }}
          DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_REPO }}
        run: |
          # Build docker image that serves the saved model artifact from the run
          # We target runs:/<run_id>/model which we logged earlier in modelling.py
          mlflow models build-docker --model-uri "runs:/$RUN_ID/model" --name "$DOCKER_IMAGE_NAME"

      - name: Push Docker image
        run: |
          docker push "${{ secrets.DOCKERHUB_REPO }}"

      - name: Publish build metadata
        run: |
          echo "Docker image pushed: ${{ secrets.DOCKERHUB_REPO }}"
