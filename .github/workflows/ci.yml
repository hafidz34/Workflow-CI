name: MLflow Project CI with Docker Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train-and-build-docker:
    runs-on: ubuntu-latest
    defaults:
      run:
        # Menjalankan semua perintah dari root repository
        working-directory: ./

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12' # Sesuaikan dengan conda.yaml

    - name: Setup Conda Environment using Micromamba
      uses: mamba-org/setup-micromamba@v1
      with:
        # Path relatif dari root repository
        environment-file: MLProject/conda.yaml
        environment-name: loan_approval_env
        cache-environment: true

    - name: Run MLflow Project using active environment
      # Menggunakan shell yang sudah diinisialisasi micromamba
      shell: bash -el {0}
      run: |
        echo "--- Verifying Environment ---"
        which python # Cek python path
        which mlflow # Cek mlflow path
        mlflow --version # Cek mlflow version
        pip install docker # Pastikan docker library terinstall
        echo "--- Running MLflow Project ---"
        # Menjalankan project dari folder MLProject
        # --env-manager=local memberitahu MLflow untuk menggunakan env yang sudah aktif
        mlflow run MLProject --env-manager=local --experiment-name "Loan Approval CI Docker"

    - name: Upload MLflow run artifacts
      # Selalu dijalankan agar kamu bisa melihat log/artifact walau gagal
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-run-artifacts
        # Path relatif dari root repository
        path: ./MLProject/mlruns

    # --- Langkah Docker hanya dijalankan jika training berhasil ---
    - name: Set up Docker Buildx
      if: success() # Hanya jika langkah mlflow run berhasil
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: success()
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and Push Docker image using MLflow
      if: success()
      shell: bash -el {0} # Butuh env Conda/MLflow aktif
      env:
        IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/loan-approval-ci # Sesuaikan nama repo jika perlu
        IMAGE_TAG: latest
      run: |
        echo "--- Building and Pushing Docker Image ---"
        # Cari folder 'model' di dalam SEMUA run di mlruns, ambil yang pertama ditemukan
        # Ini lebih robust daripada mengasumsikan Experiment ID '0'
        MODEL_ARTIFACT_PATH=$(find ./MLProject/mlruns -type d -path '*/artifacts/model' | head -n 1)

        echo "Attempting to use model artifact path: $MODEL_ARTIFACT_PATH"

        # Cek apakah variabel MODEL_ARTIFACT_PATH tidak kosong DAN folder itu ada
        if [ -n "$MODEL_ARTIFACT_PATH" ] && [ -d "$MODEL_ARTIFACT_PATH" ]; then
          echo "Model artifact path found."
          mlflow models build-docker -m "$MODEL_ARTIFACT_PATH" -t $IMAGE_NAME:$IMAGE_TAG --push --enable-mlserver
        else
          echo "Error: Model artifact path could not be found automatically inside ./MLProject/mlruns"
          echo "Please check the 'Upload MLflow run artifacts' step output to verify mlruns structure."
          echo "Is log_models=True set in mlflow.sklearn.autolog()?"
          # Tampilkan struktur mlruns untuk debugging
          echo "Current mlruns structure:"
          ls -R ./MLProject/mlruns
          exit 1
        fi